## 接口总览
- 基于 public/config.json 的端点与超时配置，封装 HTTP 与 WebSocket 通信。
- “生成任务”接口请求体采用中文键名的键值对（key:value）形式。
- 使用原生 fetch + AbortController 实现超时与拦截，WebSocket 提供任务状态订阅。

## 配置与默认值
- 配置来源：[config.json](file:///home/ubuntu/codes/cineMind/fronted/public/config.json)；加载：[configService.ts](file:///home/ubuntu/codes/cineMind/fronted/services/configService.ts)
- 字段与默认值：
  - frontendPort: 3001
  - backendHost: localhost
  - backendPort: 3000
  - timeout: 30000（毫秒）
  - endpoints.generate: /generate
  - endpoints.nodes: /nodes
- 基础 URL：protocol + backendHost + ":" + backendPort；开发 http/ws，生产 https/wss。

## HTTP 通信规范
- httpClient（fetch 封装）：
  - baseURL：`${backendHost}:${backendPort}`
  - 超时：AbortController 在 `${timeout}` 毫秒后取消请求
  - 请求拦截：统一 headers（Content-Type、Request-Id、可选鉴权）
  - 响应拦截：统一解析 ApiResponse，抛出 HttpError{ status, code, message, details, requestId }
- 响应包约定：
  - 成功：{ success: true, data }
  - 失败：{ success: false, error: { code, message, details? } }

## 生成任务接口（POST ${endpoints.generate}）—键值对请求体
- URL：`${protocol}://${backendHost}:${backendPort}${endpoints.generate}`
- 必填键（中文键名，值均为字符串）：
  - 任务ID（UUIDv4）
  - 影片类型（如 "科幻"、"剧情"）
  - 环境背景（如 "城市夜景"、"森林清晨"）
  - 图像比例（如 "16:9"、"1:1"）
  - 分辨率（如 "1024x576"、"1920x1080"）
- 可选扩展键：如 "光照风格"、"镜头语言" 等，均为字符串值。
- 示例请求：

```json
{
  "任务ID": "a6c7b8f4-9c21-4f13-8d3c-ef57e1c2c9ab",
  "影片类型": "科幻",
  "环境背景": "城市夜景",
  "图像比例": "16:9",
  "分辨率": "1024x576",
  "光照风格": "冷光",
  "镜头语言": "远景"
}
```

- 成功响应（202 Accepted 示例）：

```json
{
  "success": true,
  "data": {
    "taskId": "a6c7b8f4-9c21-4f13-8d3c-ef57e1c2c9ab",
    "accepted": true,
    "queuedAt": "2026-01-06T01:58:18.298Z"
  }
}
```

- 失败响应示例：

```json
{
  "success": false,
  "error": { "code": "INVALID_PARAM", "message": "分辨率不支持" }
}
```

- 校验：
  - 任务ID：UUIDv4
  - 图像比例："W:H" 格式
  - 分辨率："WxH" 像素格式
  - 所有值为非空字符串

## 任务状态订阅（WebSocket）
- 端点：`ws(s)://${backendHost}:${backendPort}/ws/tasks`
- 订阅：连接后发送 `{ action: "subscribe", taskId: "..." }` 或使用查询串 `?taskId=...`
- 消息模型（服务端 → 客户端）：
  - queued: { type: "queued", taskId, position }
  - running: { type: "running", taskId, progress }
  - completed: { type: "completed", taskId, imageId }
  - failed: { type: "failed", taskId, error: { code, message } }
  - heartbeat: { type: "heartbeat", ts }
- 保活与重订阅：心跳 30s；若 2×timeout 未收到心跳则重连并自动重订阅同 taskId。

## 分页查询（GET ${endpoints.nodes}）—Top 20 规则
- 规则：每次查询固定返回 Top 20 张图，按生成时间倒序（createdAt DESC）。
- URL：`${protocol}://${backendHost}:${backendPort}${endpoints.nodes}?page={page}`
  - page: 当前页码（≥1，默认 1）；size 不作为请求参数，前后端约定固定为 20。
- 响应数据示例：

```json
{
  "success": true,
  "data": {
    "page": 1,
    "size": 20,
    "total": 123,
    "items": [
      {
        "id": "img_001",
        "prompt": "城市夜景",
        "aspectRatio": "16:9",
        "resolution": "1920x1080",
        "createdAt": "2026-01-06T02:10:00.000Z",
        "thumbnailUrl": "https://.../thumbs/img_001.jpg",
        "status": "completed"
      }
    ]
  }
}
```

- 排序校验：前端断言 items[i].createdAt ≥ items[i+1].createdAt。

## 大图获取（GET ${endpoints.nodes}/{id}）
- 响应：图片二进制流（image/jpeg|png|webp）或 JSON { imageUrl }；前端以 blob 展示。
- 超时与性能：记录加载耗时与体积；超过 `${timeout}` 取消并提示。

## 错误与重试
- 4xx：直接提示
- 5xx：指数退避重试（最多 3 次）
- 网络/超时：统一提示与引导重试
- 标准化异常：HttpError{ status, code, message, details, requestId }

## 安全与加密
- 生产强制 HTTPS/WSS；开发允许 HTTP/WS。
- 不持久化敏感数据；如需鉴权使用短期 Token。
- 可选请求签名：X-Signature + X-Timestamp（演示用途），不保存密钥。

## TypeScript 类型定义

```ts
export interface ApiConfig {
  frontendPort: number;
  backendHost: string;
  backendPort: number;
  timeout: number;
  endpoints: { generate: string; nodes: string; };
}

export interface GenerateRequestKV {
  任务ID: string;
  影片类型: string;
  环境背景: string;
  图像比例: string;
  分辨率: string;
  [key: string]: string; // 允许扩展的键值
}

export interface GenerateAccepted { taskId: string; accepted: boolean; queuedAt: string; }

export type TaskEvent =
 | { type: 'queued'; taskId: string; position: number }
 | { type: 'running'; taskId: string; progress: number }
 | { type: 'completed'; taskId: string; imageId: string }
 | { type: 'failed'; taskId: string; error: { code: string; message: string } }
 | { type: 'heartbeat'; ts: string };

export interface NodeItem {
  id: string;
  prompt: string;
  aspectRatio: string;
  resolution: string;
  createdAt: string;
  thumbnailUrl: string;
  status: 'completed'|'running'|'failed'|'queued';
}

export interface PageResult { page: number; size: 20; total: number; items: NodeItem[]; }

export interface ApiSuccess<T> { success: true; data: T }
export interface ApiFail { success: false; error: { code: string; message: string; details?: unknown } }
export type ApiResponse<T> = ApiSuccess<T> | ApiFail;
```

## 测试方案
- Vitest + msw（HTTP/WebSocket 模拟）+ @testing-library/dom。
- 覆盖：配置读取与默认值合并；生成任务（键值对）必填键校验、超时与错误包；WebSocket 状态机与重连；分页 Top 20 排序断言；大图 blob 与性能。

